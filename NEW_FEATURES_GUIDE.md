# 新功能使用指南

## 📋 更新內容

### 1. 增強版管理員選單 (`/管理員選單`)

#### 功能說明
在群組中使用時，顯示該群組租戶的詳細資訊；在私訊或未綁定群組中使用時，顯示所有租戶列表。

#### 顯示內容

**① 租戶基本資訊**
- 👤 租戶名稱（例如：翻翻君11）
- 📊 狀態標示：
  - 🟢 啟用中（未到期且未停權）
  - 🟡 已降級（已到期）
  - 🔴 停權（手動停權）
- 📅 到期日（YYYY-MM-DD）
- ⏰ 剩餘天數（X 天）
- 🏢 群組額度（已用/上限）

**② 綁定的群組列表**
每個群組顯示：
- 群組名稱
- 群組 ID（尾碼8碼）
- 自動翻譯狀態（✅/❌）
- 綁定時間（月/日）

**③ 用量摘要（本期）**
- 📝 本期已翻譯字元數
- 📅 今日已翻譯字元數
- 🔧 使用的引擎比例（Google / DeepL）
- 💬 翻譯次數

#### 使用方式
```
/管理員選單
```

---

### 2. 設定群組上限 (`/設定群組上限`)

#### 功能說明
僅限主人使用，可以設定租戶最多能綁定的群組數量。

#### 使用方式
```
/設定群組上限 @用戶 數量
```

#### 參數說明
- `@用戶`: 要設定的租戶（必須使用 @ 標記）
- `數量`: 群組上限（1-999）

#### 範例
```
/設定群組上限 @小明 50
```
設定小明最多可以綁定 50 個群組

#### 注意事項
- ⚠️ 只有主人可以使用此指令
- ⚠️ 數量必須在 1-999 之間
- ⚠️ 用戶必須先是租戶（使用 /設定管理員 創建）

---

### 3. 移轉權限 (`/移轉權限`)

#### 功能說明
將自己的付費訂閱（包含剩餘時間和所有群組）轉移給其他用戶。

#### 使用方式
```
/移轉權限 @用戶
```

#### 執行流程
1. 輸入指令後，系統會顯示確認訊息
2. 輸入「是」確認移轉
3. 輸入「否」取消移轉

#### 確認訊息
```
⚠️ 確認移轉權限

移轉給：xxxxxxxx

移轉後您將無法使用付費功能，訂閱期限和群組都會轉移給對方。

請輸入「是」確認移轉，或「否」取消
```

#### 移轉內容
- ✅ 訂閱期限（剩餘天數）
- ✅ 所有綁定的群組
- ✅ 翻譯統計資料
- ✅ 群組上限設定

#### 注意事項
- ⚠️ 只有付費用戶或主人可以使用
- ⚠️ 目標用戶不能已經是租戶
- ⚠️ 移轉後原用戶將失去所有付費功能
- ⚠️ 移轉不可逆，請謹慎操作

---

### 4. 綁定群組 (`/綁定群組`)

#### 功能說明
付費用戶在群組中使用此指令，可以將該群組綁定到自己的帳號，啟用付費功能。

#### 使用方式
在群組中輸入：
```
/綁定群組
```

#### 綁定成功訊息
```
✅ 綁定成功！

📋 群組資訊
名稱：測試群組
ID：...abc12345

✓ 功能狀態（預設全開）
✅ 自動翻譯
✅ 語音翻譯
✅ 多語言支援
✅ 翻譯引擎切換

📊 當前狀態：有效
👤 綁定人：xxxxxxxx
🏢 群組額度：3/20

💡 使用 /選單 設定翻譯語言
```

#### 預設功能狀態
綁定成功後，以下功能預設全部開啟：
- ✅ 自動翻譯
- ✅ 語音翻譯
- ✅ 多語言支援
- ✅ 翻譯引擎切換（Google/DeepL）

#### 群組資訊記錄
系統會自動記錄：
- 群組名稱（透過 LINE API 取得）
- 群組 ID
- 綁定人（執行指令的用戶）
- 綁定時間
- 群組設定

#### 超過上限提示
如果已達群組上限：
```
❌ 已超過綁定上限

當前: 20/20

請退出舊群組或聯繫管理員擴充上限
```

#### 注意事項
- ⚠️ 只能在群組中使用
- ⚠️ 只有有效的付費用戶可以綁定
- ⚠️ 每個群組只能被一個租戶綁定
- ⚠️ 綁定數量受群組上限限制
- ⚠️ 訂閱到期後功能會受限

---

### 5. 自動離開機制

#### 功能說明
當租戶管理員或綁定人離開群組時，翻譯機器人會自動退出該群組。

#### 觸發條件
- 租戶本人離開群組
- 綁定人（執行 /綁定群組 的用戶）離開群組

#### 執行流程
1. 偵測到管理員離開
2. 機器人發送離開通知
3. 機器人自動退出群組
4. 資料庫更新群組狀態為無效

#### 離開通知
```
👋 管理員已離開群組，翻譯機器人也將退出。
如需繼續使用，請重新綁定。
```

#### 資料保留
- ✅ 群組資料會保留在資料庫
- ✅ 群組標記為無效（is_active=False）
- ✅ 可以重新綁定該群組

---

## 📊 資料庫更新

### 新增欄位

#### Tenant 表
```python
name = db.Column(db.String(100), default='翻翻君')  # 租戶名稱
is_suspended = db.Column(db.Boolean, default=False)  # 手動停權
max_groups = db.Column(db.Integer, default=20)  # 群組上限
today_char_count = db.Column(db.Integer, default=0)  # 今日字元數
last_reset_date = db.Column(db.Date, default=datetime.utcnow)  # 上次重置日期
google_count = db.Column(db.Integer, default=0)  # Google 使用次數
deepl_count = db.Column(db.Integer, default=0)  # DeepL 使用次數
```

#### Group 表
```python
group_name = db.Column(db.String(200), default='未知群組')  # 群組名稱
bound_by_user_id = db.Column(db.String(100))  # 綁定人
is_active = db.Column(db.Boolean, default=True)  # 是否有效
bound_at = db.Column(db.DateTime, default=datetime.utcnow)  # 綁定時間
```

### 新增方法

#### Tenant 模型
```python
get_status()  # 取得狀態顯示（🟢/🟡/🔴）
can_add_group()  # 檢查是否可以新增群組
reset_daily_stats()  # 重置每日統計
```

---

## 🚀 使用流程範例

### 情境 1：管理員設定新租戶

```bash
# 1. 主人創建租戶（6個月）
/設定管理員 @用戶 6

# 2. 設定群組上限（50個）
/設定群組上限 @用戶 50

# 3. 用戶綁定群組
@用戶: /綁定群組

# 4. 查看管理面板
/管理員選單
```

### 情境 2：付費用戶自行管理

```bash
# 1. 在群組中綁定
/綁定群組

# 2. 查看自己的訂閱資訊
/付費選單

# 3. 設定翻譯語言
/選單

# 4. 移轉給其他人（如果需要）
/移轉權限 @新用戶
是
```

### 情境 3：管理員查看租戶狀態

```bash
# 在租戶的群組中
/管理員選單

# 查看詳細資訊
/租戶資訊

# 查看系統統計
/統計
```

---

## ⚠️ 注意事項

### 權限說明
- **主人**：所有功能都可使用
- **白名單用戶**：可查看管理面板
- **付費用戶**：可綁定群組、移轉權限、查看付費選單
- **一般用戶**：只能使用翻譯功能

### 群組上限
- 預設上限：20 個群組
- 可由主人調整：1-999 個
- 達到上限時無法綁定新群組

### 自動降級
- 到期後自動降級為免費版
- 不會刪除群組和資料
- 可隨時續費恢復

### 統計重置
- 今日統計每天自動重置
- 本期統計累積到續費或移轉
- 引擎比例即時計算

---

## 🔧 故障排除

### 無法綁定群組
1. 檢查訂閱是否有效
2. 確認未達群組上限
3. 確認群組未被其他租戶綁定

### 管理員選單無資料
1. 確認有管理員權限
2. 在群組中使用時，確認群組已綁定租戶

### 移轉失敗
1. 確認目標用戶不是租戶
2. 確認自己是付費用戶
3. 必須輸入「是」才會執行

### 機器人未自動離開
1. 檢查離開的是否為租戶或綁定人
2. 確認 LINE Bot 有離開群組權限
3. 查看日誌確認錯誤訊息

---

**最後更新：2026-01-09**
